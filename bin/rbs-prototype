#!/usr/bin/env ruby

require 'fileutils'

def rb_to_rbs(file_name)
  file_name.gsub(/\.rb\Z/, '.rbs')
end

SIG_BASEDIR = "sig"
RBS_RAILS_DIRECTORY = 'rbs_rails'

INCLUDED_DIRECTORIES = [
  "app",
  "lib",
  "lib_static",
]

ruby_files = Dir["{#{INCLUDED_DIRECTORIES.join(",")}}/**/*.rb"]

ruby_files.each do |fn|
  rbs_filename = rb_to_rbs(fn)
  print "#{fn} -> "

  rbs_rails_fn = File.join(SIG_BASEDIR, RBS_RAILS_DIRECTORY, rbs_filename)
  rbs_target_fn = File.join(SIG_BASEDIR, rbs_filename)
  if File.exist?(rbs_rails_fn)
    puts "🚂 File has been generated by rbs_rails, skipping"
  elsif File.exist?(rbs_target_fn)
    puts "❌ File already exists, skipping to not risk overwriting existing stuff"
  else
    FileUtils.mkdir_p(File.dirname(rbs_target_fn))
    `bundle exec rbs prototype rb #{fn} > #{rbs_target_fn}`
    puts "✅"
  end
end
