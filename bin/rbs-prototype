#!/usr/bin/env ruby

require 'fileutils'

def rb_to_rbs(file_name)
  file_name.gsub(/\.rb\Z/, '.rbs')
end

SIG_BASEDIR = "sig"

RBS_RAILS_DIRECTORY = 'rbs_rails'

puts "💎 Going through regular Ruby directories"
puts "-----------------------------------------"
puts ""

INCLUDED_DIRECTORIES = [
  "app",
  "lib",
  "lib_static",
]

ruby_files = Dir["{#{INCLUDED_DIRECTORIES.join(",")}}/**/*.rb"]

ruby_files.each do |fn|
  rbs_filename = rb_to_rbs(fn)
  print "#{fn} -> "

  rbs_rails_fn = File.join(SIG_BASEDIR, RBS_RAILS_DIRECTORY, rbs_filename)
  rbs_target_fn = File.join(SIG_BASEDIR, rbs_filename)
  if File.exist?(rbs_rails_fn)
    puts "🚂 File has been generated by rbs_rails, skipping"
  elsif File.exist?(rbs_target_fn)
    puts "❌ File already exists, skipping to not risk overwriting existing stuff"
  else
    FileUtils.mkdir_p(File.dirname(rbs_target_fn))
    `bundle exec rbs prototype rb #{fn} > #{rbs_target_fn}`
    puts "✅"
  end
end

puts ""
puts "🔩 Going through modules"
puts "------------------------"
puts ""

module_directories =  Dir["modules/*"]

module_directories.each do |mod_dir|
  files = Dir["#{mod_dir}/{app,lib}/**/*.rb"]

  files.each do |fn|
    rbs_filename = rb_to_rbs(fn)
    rbs_basename = rbs_filename.gsub(mod_dir, "")

    rbs_rails_in_main_app_fn = File.join(SIG_BASEDIR, RBS_RAILS_DIRECTORY, rbs_basename)
    rbs_target_fn = File.join(mod_dir, SIG_BASEDIR, rbs_basename)

    print "#{fn} -> "

    if File.exist?(rbs_rails_in_main_app_fn)
      puts "🚂 File has been generated by rbs_rails in main sig folder, skipping"
    elsif File.exist?(rbs_target_fn)
      puts "❌ File already exists, skipping to not risk overwriting existing stuff"
    else
      FileUtils.mkdir_p(File.dirname(rbs_target_fn))
      `bundle exec rbs prototype rb #{fn} > #{rbs_target_fn}`
      puts "✅"
    end
  end
end
