#!/bin/bash -e

SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )

# Wait for the DB to be up
WAIT_FOR_MIGRATIONS=false bundle exec rails runner $SCRIPT_DIR/wait_for_db.rb

OUTPUT=$(echo "\dt" | psql `echo $DATABASE_URL | cut -d? -f1` 2>&1)

if [[ "$OUTPUT" = "No relations found." ]]; then
	echo "Initialising database and running seed..."
	DISABLE_DATABASE_ENVIRONMENT_CHECK=1 bundle exec rake db:structure:load db:seed
else
	echo "Executing database migration and database seed..."
	bundle exec rake db:migrate db:seed
fi

if [ "$1" = "--set" ]; then
	shift
	echo "Update application settings..."
	bundle exec rake setting:set["$@"]
fi

exit 0
